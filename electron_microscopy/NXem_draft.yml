#kuehbacm at hu-berlin.de, 12/2021
#a draft version of a NeXus application definition for electron microscopy
#the draft describes primarily components of an electron microscope to motivate the need for a base class for enabling the description of electron microscopes
#the example here illustrates also how a specific experiment with an electron microscope, scanning nanobeam diffraction in a transmission electron microscope could be described using these components in the class
#These components can be used to create a general template for electron microscopy application definitions. In detail an electron microscope is, like most contemporary instruments for advanced materials characterization,
#a complex instrument with sets of many components with internal hierarchies of hardware components and associated software control units. The class coarse-grains this complexity to the level of how the components are
#presented in contemporary instruments to normal microscopy users, like PhD students. Using the general NXem_lens class the example of the NXem_c3c5corr class shows how these components can be connected to resolve
#a more complicated and convering description of the internals of the instrument with a focus on building e.g. digiral twins of the instrument. Such an application definition for instantiating e.g. the entire column
#of the instrument digitally to perform e.g. ray-tracing simulation is not the purpose of the application definition but should be possible with making more fine-grained additions of the hard- and software layers.
#Here, instances of NXtransformations describe the location and geometrical situation of the components relative to the optical axis/electron beam path. Complementarily, instances of NXprocess can be used to describe
#numerical data processing steps which happen to modify the data immediately after their acquisition. Common examples are time-averaging of images which are taken with high-frame rate capable direct electron detectors, 
#or the online processing of (Kikuchi) diffraction pattern in techniques like electron backscatter diffraction.
name: NXem_draft
category: contributed
doc: Draft set of components for a contributed class which is general enough to describe electron microscopy experiments.
symbols:
  doc: The symbols used in the schema to specify e.g. dimensions of arrays
  imageid: Frame or given number to distinguish different images in a stack
  ypos: Pixel coordinate in the slow-changing direction
  xpos: Pixel coordinate in the fast-changing direction
  nimages: Total number of images in the imagestack
  ny: Number of pixel along the slow-changing direction
  nx: Number of pixel along the fast-changing direction
(NXentry):
  exists: required
  #if the exists keyword is not used the default is exists optional
  doc: Application definition for storing data and metadata for experiments with (scanning and transmission) electron microscopy
  definition:
    exists: required
    doc: Official NeXus NXDL schema to which this entry conforms.
    \@version:
      doc: Version specifier enabling to document modification of the schema.
  experiment_identifier:
    exists: required
    doc: Ideally, a (globally persistent) unique identifier for referring to this experiment. The identifier is usually defined/issued by the facility, laboratory, or the principle investigator. The identifier enables to link experiments to e.g. a proposal.
  experiment_description:
  start_time(NX_DATE_TIME):
    exists: recommended
  end_time(NX_DATE_TIME):
    exists: recommended
  time_zone(NX_DATE_TIME):
    exists: required
    doc: ISO 8601 time_zone offset from UTC.
  duration(NX_INT):
    unit: NX_TIME
  collection_time(NX_INT):
    unit: NX_TIME
  program_name:
    exists: recommended
    doc: Commercial or otherwise given name to the program which was used to acquire/measure the dataset. Electron microscopy experiments are usually controlled/performed via commercial integrated acquisition and instrument control software. In many case an EM dataset is useful only if its post-processed already during the acquisition or shortly thereafter, i.e. while still at the microscope. Often these processes are automated. Examples include collecting of diffraction pattern and on-the-fly indexing of these. These situations and tools are realized with individual NXprocess groups which can hold more details and numerical data to these processing steps.
    \@version:
      exists: recommended
      doc: Program version i.e. build number, commit hash, or description of a (online) repository where the source code of the program and build instructions can be found so that the program can be configured ideally in such a manner that the result file is numerically recreatable in the same deterministic manner.
  experiment_documentation(NXnote):
    exists: optional
    doc: Binary container for a file which can be used to add a description of additional details to the experiment. The container can hold e.g. a ppt, pdf, latex, txt, image, ...).
  thumbnail(NXnote):
    exists: recommended
    doc: A small image that is representative of the entry. This can be an image from the dataset or a thumbnail of a spectrum. Either way it is recommended to use 640x480 pixel jpeg image.
    \@type:
  operator(NXuser):
    exists: [min, 1, max, infty]
    doc: Contact information of at least the user of the instrument who measured this specimen or the principal investigator who performed this experiment. Adding multiple users if relevant is recommended.
    name:
      exists: required
    affiliation:
      exists: recommended
      doc: Name of the affiliation of the user at the point in time when the experiment was performed.
    address:
      exists: recommended
    email:
      exists: required
    orcid:
      exists: recommended
    telephone_number:
      exists: recommended
    role(NX_CHAR):
      exists: optional
      doc: Which role does the person have (e.g. technician operating the microscope, student, postdoc, principal investigator, ...)
  sample(NXsample): #in electron microscopy we probe both statistically representative, i.e. samples and less representative samples, specimens, in FAIRmat here we go for sample because if a sample is representative for a certain analysis task or not is not an inherent property of the sample but depends on the application, a case- and research-question dependent qualification.
    exists: required
    name:
      exists: required
      doc: Descriptive name or identifier with which to distinguish the specimen from all others. In cases where the specimen was e.g. site-specifically cut from samples or in cases of an instrument session during which multiple specimens are loaded, the name has to be descriptive enough to resolve which specimen was measured. The user is advised to store the details how specimens are cut from samples in the sample history.
    sample_history:
      exists: required
      doc: Ideally, a reference to the location of or a (globally persistent) unique identifier of e.g. another file which should document ideally as many details as possible of the material, its microstructure, and its thermo-chemo-mechanical processing/preparation history. In the case that such a detailed history of the sample/specimen is not available, use this field as a free-text description to specify a sub-set of the entire sample history, i.e. what you would consider being the key steps of the preparation.
    preparation_date(NX_DATE_TIME):
      exists: required
      doc: ISO8601 date and time when the specimen was prepared. This is especially required for environmentally sensitive samples such as hydrogen-charged specimens or experiments including tracers with a short half-time.
    preparation_time_zone(NX_DATE_TIME):
      exists: required
      doc: ISO 8601 time_zone offset from UTC. Required, as it is possible that the specimen was prepared in a different place/laboratory than where the experiment/measurement is performed.
    short_title:
    atom_types:
      exists: required
      doc: "Use Hill's system for listing elements of the periodic table which are inside or attached to the surface of the specimen and thus relevant from a scientific point. This field can be used by materials database systems to parse the relevant elements without having to interpret these from the sample history."
  (NXdata):
    exists; required
    doc: Hard link to a location/locations in the hierarchy of the NeXus file where the data for default plotting are stored.
  scan_align(NXprocess):
    program_name:
      exists: required
      doc: Commercial or otherwise defined given name to the program that was used to process the data on-the-fly.
    program_version:
      exists: required
      doc: Either version with build number, commit hash, or description of a (online) repository where the source code of the program and build instructions can be found so that the program can be configured in such a way that result files can be created ideally in a deterministic manner.
    description:
      exists: required
      doc: Ideally, a reference to the location or a unique (globally persistent) identifier (e.g.) of e.g. another file which gives as many as possible details of this processing steps. In the case that such a detailed history of the processing (steps) is not available, use this field as a free-text description of this processing.
  em_lab(NXinstrument):
    exists: required
    name:
      doc: Name of the microscope.
    #manufacturer_name and manufacturer_model, make consistent throughout the contributed classes for the components of an EM
    instrument_manufacturer:
      exists: required
      doc: Manufacturer of the entire instrument to enable e.g. queries in nomad about experiment for manufacturers. Usually more technical details are needed, which is why it is recommended to fill as many of the individual components of the instrument as required for interpreting the experiment.
    instrument_model:
      exists: recommended
      doc: Manufacturer brand/model to enable e.g. queries about microscope models. See comments on instrument_manufacturer on how to provide further specification.
    instrument_capability:
      doc: "Free-text list possibly multiple terms of functionalities which the instrument provides. The values are to be picked from a bag of controlled words. Examples are Feg, Astar, OmegaFilter."
    electron_gun(NXsource):
      exists: required
      doc: The source creating the electron beam.
      voltage(NX_FLOAT):
        exists: required
        doc: Voltage relevant to compute the energy of the electrons immediately after they left the gun.
        unit: NX_VOLTAGE
      probe:
        exists: required
        enumeration: [electron]
      wavelength(NX_FLOAT):
        unit: NX_WAVELENGTH
      emitter_type:
        exists: required
        doc: Emitter type used to create the beam. Choose one of the following thermionic, schottky, feg #do we need an extra option in the enum for cold FEGs ?
        enumeration: [thermionic, schottky, field emission]
      description:
        doc: Ideally a reference to (another) file (ideally formatted using also an application definition) via a link, name, or a (globally persistent) unique identifier to give further details about the electron gun.
    gun_aperture(NXaperture):
    condenser_lens1(NXem_lens):
    condenser_lens2(NXem_lens):
    #NXaperture should ideally have all NXtransformations to enable a description where they relative to the virtual source generated by the electron gun and how are the components arranged along the optical axis
    condenser_lens1_aperture(NXaperture):
      #an example how NXaperture should be modified, the GitHub repo indicates NXaperture is a target for improvements
      doc: An aperture (or diaphragm) for the electron beam.
      name:
      manufacturer_name:
        doc: Name of the manufacturer who built/constructed the aperture.
      manufacturer_model:
        doc: Hardware name/serial number or hash identifier given by the manufacturer to identify the aperture.
      description:
        doc: An (ideally globally persistent) unique identifier, link, or text which gives further details.
# the two next entries should be worked out in more details.
      type:
        doc: Qualitative description which type of aperture.
        enumeration: [circular]
      diameter(NX_FLOAT):
        exists: required
        doc: Relevant diameter in the case of circular aperture.
        unit: NX_LENGTH
      (NXtransformations):
        doc: Geometrical description where the aperture is mounted in the microscope column relative to the electron beam (path).
    condenser_lens2_aperture(NXaperture):
    cs_corrector(NXem_c3c5corr):
    prefield_or_mini_lens(NXem_lens):
    scanning_coils(NXem_deflector):
    specimen_stage(NXstage):
    objective_lens(NXem_lens):
    objective_mini_lens(NXem_lens):
    selected_area_aperture(NXaperture):
    intermediate_lens1(NXem_lens):
    intermediate_lens2(NXem_lens):
    intermediate_lens3(NXem_lens):
    intermediate_lens4(NXem_lens):
    haadf_detector(NXdetector):
    #omega_filter(NXem_omegafilter):
    #an omega filter is an energy filtering device, a specific component of many (transmission) electron microscopes, this instrument is again an ensemble of beam bending and electro-magnetic lenses so it should have an own application definition.
    energy_filter1_aperture(NXaperture):
    energy_filter1(NXfilter):
    projector_lens1(NXem_lens):
    projector_lens2(NXem_lens):
    projector_lens3(NXem_lens):
    projector_lens4(NXem_lens):
    fluorescent_screen_detector(NXdetector):
    #mirror1(NXem_mirror):
    ccd_camera1(NXdetector):
      doc: Description of the type of the detector e.g. CCD, scintillator, direct electron, image plate, CMOS
      manufacturer_name:
        exists: required
        doc: Name of the manufacturer who built/constructed the detector
      manufacturer_model:
        exists: required
        doc: Hardware name/serial number or hash identifier given by the manufacturer to identify the detector.
      sensor_material:
      bit_depth_readout(NX_INT):
      number_of_cycles(NX_INT):
      x_pixel_size(NX_FLOAT):
        unit: NX_LENGTH
      y_pixel_size(NX_FLOAT):
        unit: NX_LENGTH
      flatfield_applied(NX_BOOLEAN):
      flatfield(NX_FLOAT):
      exposure(NX_NUMBER):
        unit: NX_TIME
      description:
        doc: Free text option to write further details about the detector.
      (NXcollection):
        darkfield_applied(NX_BOOLEAN):
          doc: to be defined, what is the idea of the darkfield here, using the camera for dark field imaging mode or is this related to eigen noise of the detector without illumination
        darkfield(NX_FLOAT):
          doc: what is the idea of the darkfield here, using the camera for dark field imaging mode or is this related to inherent noise of the detector without illumination
        pixel_size_x(NX_FLOAT):
          unit: NX_PER_LENGTH
        pixel_size_y(NX_FLOAT):
          unit: NX_PER_LENGTH
        cartesian_scan_dimensions(NX_UINT):
          doc: NX_DIMENSIONLESS
        cartesian_scan_dimension1_count(NX_UINT):
        cartesian_scan_dimension2_count(NX_UINT):
        cartesian_scan_dimension3_count(NX_UINT):
        scan_properties(NXcollection): #we need to discuss if we allow NXcollections to be nested or rather have them laid out in a flat manner
          scan_system_name:
          x_points_step_width(NX_NUMBER):
            unit: NX_LENGTH
          y_points_step_width(NX_NUMBER):
            unit: NX_LENGTH
    dark_field_detector(NXdetector):
    bright_field_detector(NXdetector):
    ccd_camera2(NXdetector):
    eels_aperture(NXaperture):
    eels_detector(NXdetector):