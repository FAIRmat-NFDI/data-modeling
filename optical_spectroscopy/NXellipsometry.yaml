#11/2021
#a draft version of a NeXus application definition for ellipsometry

# the document has the following main elements:
# instrument used and is characteristics
# measured data, the discription of the sample and what was measured about it
# derived parameters: extra parameters derived in the measurement software

# one would need a Class/ separate entry for the sample description which can link to and should contain a full description of the composition. A free description as text might be not enough or unclear. Especially if one deals with many layer structured samples and optically anisotropic samples, like triclinic one
#
# Comments are moved to the Development_notes.md file

category: application
name: NXellipsometry
doc: "Draft application definition for ellipsometry measurements, including complex systems up to variable angle spectroscopic ellipsometry."
symbols:
  doc: Variables used throughout the document, e.g. dimensions and important parameters
  angle_of_incidence: The angle of incidence to the surface normal (stage normal) of the sample
  N_wavelength: Size of the energy / wavelength vector used
  N_variables: How many variables are saved in a measurement (e.g. Psi and delta, Mueller matrix)
  N_angles: Number of incident angles used
  N_p1: Number of first sample parameters scanned
  N_time: Number of time points measured
  # we can go on, but this is already an at least 4 dimensional data set to work with

(NXentry):
  exists: required
  #if the exists keyword is not used the default is exists optional
  doc: "This is the application definition describing ellipsometry experiments. Such experiments may be as simple as identifying how a reflected beam of light with a single wavelength changes its polarization state, to a variable angle spectroscopic ellipsometry experiment.\n
    The application definition defines:
      - elements of the experimental instrument
      - calibration information if available
      - parameters used to tune the state of the sample
      - sample description"
  experiment_identifier:
    exists: required
    doc: "Unique identifier of the experiment, such as a (globally persistent) unique identifier.
      - The identifier is usually defined by the facility or principle investigator.
      - The identifier enables to link experiments to e.g. proposals."
  experiment_description:
    exists: required
  start_time(NX_DATE_TIME):
    exists: required
    unit:  NX_TIME
  program_name:
    doc: "Commercial or otherwise defined given name to the program that was used to generate the results file(s) with measured data and metadata."
  program_version:
    doc: "Either version with build number, commit hash, or description of a (online) repository where the source code of the program and build instructions can be found so that the program can be configured in such a way that result files can be created ideally in a deterministic manner."
  time_zone(NX_DATE_TIME):
    exists: required
    doc: ISO 8601 time_zone offset from UTC.

  definition_local:
    doc: FAIRmat-specific candidate proposal for an application definition exemplifying ellipsometry.
    \@version:
      doc: "Ideally version with build number are commit hash of the application definition. If not available a free-text description."
    \@url:
      doc: URL where to find further material (documentation, examples) relevant to the application definition

  operator(NXuser):
    exists: [min, 1, max, infty]
    doc: "Contact information of at least the user of the instrument or the investigator who performed this experiment. Adding multiple users if relevant is recommended."
    name:
      exists: required

    affiliation:
      exists: recommended
      doc: "Name of the affiliation of the user at the point in time when the experiment was performed."
    address:
      exists: recommended
    email:
      exists: required
    orcid:
      exists: recommended
    telephone_number:
      exists: recommended

  instrument(NXinstrument):
    doc: General properties of the ellipsometry equipment
    exists: required
    model:
      doc: The name of the instrument
    company:
      doc: Name of the company which build the instrument"
    construction_year(NX_DATE_TIME):
      doc: ISO8601 date when the instrument was constructed
      unit: NX_TIME
    hardware_version:
      doc: The used version of the hardware if available
    software_name:
      doc: Name (e.g. commercial) of the software that was used for the measurement
    software_version:
      doc: Version and build number or commit hash of the software source code

    light_source:
      doc: Specify the used light source
    focussing_probes(NX_BOOLEAN):
      doc: Were focussing probes (lenses) used or not?
    data_correction(NX_BOOLEAN):
      doc: Were the recorded data corrected by the window effects of the lenses or not?
    angular_spread(NX_NUMBER):
      doc: Specify the angular spread caused by the focussing probes
      unit: NX_ANGLE
    ellipsometry_type:
      doc: What type of ellipsometry was used? See Fujiwara Table 4.2.
      enumeration: [rotating analyzer, rotating analyzer with analyzer compensator, rotating analyzer with polarizer compensator, rotating polarizer, rotating compensator on polarizer side, rotating compensator on analyzer side, modulator on polarizer side, modulator on analyzer side, dual compensator, phase modulation, imaging ellipsometry, null ellipsometry]

    calibration(NXsubentry):
      doc: "Ellipsometers require regular calibration to adjust the hardware parameters for proper zero values and background light compensation"
      calibration_time(NX_DATE_TIME):
        doc: ISO8601 datum when calibration was last performed before this measurement
        # NX_DATE_TIME is the ISO8601 format, possibly with time zone
        unit: NX_DATE_TIME
        #alternative (NX_CHAR) and then add
        #enumeration: [no calibration, within 1 hour, within 1 day, within 1 week]

      calibration_sample:
        doc: "Which sample was used to calibrate the window effect? Provide a sample identifier if possible."

      calibration_data(NXsubentry):
        exists: recommended
        doc: "Arrays which provide the measured calibration data. Multiple sets are possible, e.g. Psi and delta measured on an e.g. silicon calibration waver, and the straight-through data."
        data_type:
          doc: "What data was recorded for the calibration"
          enumeration: [psi/delta, tan(psi)/cos(delta), Jones matrix, Mueller matrix, not provided]
        N_calibration_angles(NX_NUMBER):
          doc: how many incident angles were used for the calibration?
          unit: NX_UNITLESS

        angle_of_incidence(NX_NUMBER):
          doc: angle(s) of incidence used during the calibration measurement
          unit: NX_ANGLE

        wavelength(NX_NUMBER):
          doc: "The wavelength or equivalent values (which are inter-convertible). The importer should convert all to one unit, and make the others accessible. Historically, energy is used in eV, but for visible spectroscopy wavelength is more common, for IR wave numbers in 1/cm units.
            This is a link to the measurement wavelengths used, defined at the instrument"
          link: '/instrument/wavelength'

        calibration_data(NX_NUMBER):
          doc: "Calibration is performed on a reference surface (usually silicon wafer with well defined oxide layer) at a number of angles, then in a straight through mode (transmission in air)."
          unit: NX_UNITLESS
          dimensions:
            rank: 2
            dim: [[2, N_calibration_angles+1], [1, N_wavelength]]

        calibration_sample(NX_CHAR):
          doc: "Free-text to describe which sample was used for calibration, e.g. silicon wafer with 25 nm thermal oxide layer"

    angle_of_incidence(NX_NUMBER):
      doc: "the incident angle of the beam vs. the normal of the bottom reflective (substrate) surface in the sample"
      unit: NX_ANGLE
      \@target: "/instrument/angle_of_incidence"
      dimensions:
        rank: 1
        dim: [[1, N_angles]]

    stage(NXsubentry):
      # this needs at least a contributed class where you collect the members we could generalize NXem_stage to NXstage
      # It would be nice to make it a base class
      exists: required
      \@target: '/instrument/stage'
      doc:  "Sample stage, holding the sample at a specific position in X,Y,Z (Cartesian) coordinate system and at an orientation defined by three Euler angles (alpha, beta, gamma). The stage may be motorized or manual, special for liquids or gas environment."
      enumeration: [manual stage, scanning stage, liquid stage, gas cell]
      stage_orientation(NXtransformations):
        doc: "The stage coordinate system vs. the incident beam. The Z-axis of the stage is considered to point along the normal of the substrate (bottom reflecting surface) from the stage towards the general direction of the light source. The beam comes with angle of incidence towards this Z-axis, but in opposite direction, thus they are connected with a rotation of 180 - angle of incidence (in degrees). This transformation brings us from the NEXUS coordinates to the stage coordinates."

        #value: 180 - angle_of_incidence
        # type(NX_NUMBER): -- does not apply
        \@transformation_type: rotation
        \@vector: [1, 0, 0]
        \@depends_on: .

      translation(NXtransformations):
        # we need also a reference point with respect to the sample
        doc: "To identify what is measured and how, we have to define the sample relative to the instrument. Translation defines the shift along a vector provided by X,Y,Z. This identifies the position where the beam hits the sample relative to a predefined position on the sample (e.g. bottom left corner). The transformation method is described at https://manual.nexusformat.org/design.html#tb-table-transform"
        exists: required
        X__AXISNAME(NX_NUMBER):
          # its value is the actual shift in this direction
          # unit is defined by the transformation type below
          doc: perpendicular to the plane of incidence, to the right hand side from the direction of the beam
          \@transformation_type: translation
          \@vector: [1, 0, 0]
          \@depends_on: stage_orientation
        Y__AXISNAME(NX_NUMBER):
          doc: direction of the beam along the stage towards the detector
          \@transformation_type: translation
          \@vector: [0, 1, 0]
          \@depends_on: X
        Z__AXISNAME(NX_NUMBER):
          doc: "Z defined by the normal of the top reflective surface in the general direction of the light source. Its value is defined by maximizing the reflected intensity of the beam in reflection mode. Then it is fixed. In transmission mode it is variable."
          \@transformation_type: translation
          \@vector: [0, 0, 1]
          \@depends_on: Y

        alternative:
          doc: If there is no motorized stage, we should at least qualify where the beam hits the sample.
          enumeration: [top, bottom, middle, top right, top left, bottom right, bottom left, middle right, middle left]

      sample_rotation(NX_transformations):
        doc: "Euler angles; the angle between a preferred direction on the sample to the direction of the beam along the stage surface (projected; source to detector); According to documentaiton, the axis definition is always from the referred system (https://manual.nexusformat.org/design.html#tb-table-transform)."
        alpha(NX_NUMBER):
          doc: first rotation is around the Z-axis
          \@transformation_type: rotation
          \@vector: [0, 0, 1]
          \@depends_on: Z
        beta(NX_NUMBER):
          doc: second is around the rotated x' axis
          \@transformation_type: rotation
          \@vector: [1, 0, 0]
          \@depends_on: alpha
        gamma(NX_NUMBER):
          doc: rotate around the last Z-axis, z''; see wikipedia Proper Euler Angles image, Z1,Z2,Z3
          \@transformation_type: rotation
          \@vector: [0, 0, 1]
          \@depends_on: beta
        alternative:
          doc: a describe the sample orientation relative to the plane of incidence (reflection mode)
          enumeration: [parallel, perpendicular, diagonal]

      window(NXaperture):
        doc: "For environmental measurements, the environment (liquid, vapor, etc.) is enclosed in a cell, which has windows both in the direction of the source and the detector (looking from the sample). These winwows also add a phase shift to the light altering the measured signal. This shift has to be corrected based on measuring a known sample in the environmental cell."
        material(NX_CHAR):
          doc: the material of the window

        thickness(NX_NUMBER):
          doc: Thickness of the window
          unit: NX_LENGTH

        orientation_angle(NX_NUMBER):
          doc: "Angle of the window normal (outer) vs. the substrate normal (similar to the angle of incidence)."
          unit: NX_ANGLE

      reference_data(NXsubentry):
        # NXdata is a view of data, here we have a set of information, use subentry
        doc: "Please include here the recorded data that can be used to calculate the window effect. Typically this is the substrate (e.g. silicon with thermal oxide layer) in air without window and in a known liquid with the window."

        wavelength(NX_NUMBER):
          doc: "Calibration is performed on a reference surface (usually silicon wafer with well defined oxide layer) at a number of angles, then in a straight through mode (transmission in air)."
          unit: NX_LENGTH
          link: '/instrument/wavelength'

        data(NX_NUMBER):
          doc: "Recorded data of a reference surface with and without window / medium."
          unit: NX_UNITLESS
          #can one specify the dimensions of these calibration data?
          dimensions:
            rank: 3
            dim: [[3,2], [2, N_angles], [1, N_wavelength]]

    detector(NXdetector):
      doc: "Which type of detector was used, and what is known about it? A detector can be a photomultiplier (PMT), a CCD in a camera, an array in a spectrometer. If so, the whole detector unit goes in here."

      detector_type:
        exists: required
        doc: "What kind of detector module is used, e.g. CCD-spectrometer, CCD camera, PMT, photodiode, etc."
        enumeration: [PMT, photodiode, avalanche diode, CCD camera, CCD spectrometer]
          # we may have to complete this, not all may be listed yet

      duration(NX_NUMBER):
        doc: Integration time for the measurement. Single number or array if it was varied.
        unit: NX_TIME
      revolution(NX_NUMBER):
        doc: Define how many rotations of the rotating element were taken into account per spectrum.
        unit: NX_ANY

      rotating_element:
        doc: Define which elements rotates, e.g. polarizer or analyzer...
        enumeration: [polarizer (source side), analyzer (detector side), compensator (source side), ccompensator (detector side)]

      fixed_revolution(NX_NUMBER):
        doc: rotation rate, if the revolution does not change during the measurement.
        unit: NX_FREQUENCY

      variable_revolution(NX_NUMBER):
        doc: Specify maximum and minimum values for the revolution.
        dimensions:
          rank: 1
          dim: [[1, 2]]

  sample(NXsample):
    exists: required
    atom_types:
      exists: required
      doc: "Use Hill's system for listing elements of the periodic table which are inside or attached to the surface of the specimen and thus relevant from a scientific point. The purpose of this field is to allow materials database to parse the relevant elements without having to interpret the sample history or other fields."
    name:
      exists: required

    sample_history:
      exists: required
      doc: "Ideally, a reference to the location or a unique (globally persistent) identifier (e.g.) of e.g. another file which gives as many as possible details of the material, its microstructure, and its thermo-chemo-mechanical processing/preparation history. In the case that such a detailed history of the sample is not available, use this field as a free-text description to specify details of the sample and its preparation."
    preparation_date(NX_DATE_TIME):
      exists: required
      unit: NX_DATE_TIME
    preparation_time_zone(NX_DATE_TIME):
      exists: required
      doc: "ISO 8601 time_zone offset from UTC. The time zone can be different to the time zone of this experiment description because maybe the sample was prepared by one international group and is then measured in a different time zone."
      unit: NX_DATE_TIME
    description:
      doc: "Specimen/sample preparation and previous processing steps is the history which the sample carries when it is mounted in the electron microscope. Therefore, preparation details and other points of this history should be stored in sample_history."

    layer_structure:
      #is my interpretation of this member, reflected in the docstring, following your idea Tamas/Chris?
      doc: "Qualitative description of the layer structure for the sample in cases where a detailed geometrical description is not available or desired/required."

    orientation_matrix(n_comp, 3, 3):
      # documentation is of the original NEXUS class
      unit: NX_ANGLE
      dimensions:
        rank: 1
        dim: [[1, 3]]

    data_identifier(NX_NUMBER):
      doc: "A identifier to correlate data to the experimental conditions, if several were used in this measurement; typically an index of 0 - N"
      #what about uniqueness of the identifier?
      #  -- append it to the experiment identifier...

    data_type:
      exists: required
      doc: "Select which type of data was recorded. It is possible to have multiple selections. Data types may also be converted to each other, e.g. a Mueller matrix contains N,C,S data as well."
      enumeration: [psi / delta, tan(psi)/cos(delta), NCS, Mueller matrix, Jones matrix, N/C/S, raw data]

    number_of_variables(NX_UINT):
      doc: "specify the number of variables stored, e.g. psi, delta and their errors are 4 (this can be also automated, based on the provided data table)"
      #we should use maybe in the future again the concepts of symbols

    wavelength(NX_NUMBER):
      doc: "Wavelength value(s) used for the measurement.\n
        An array of 1 or more elements. Length defines N_wavelength"
      unit: NX_LENGTH
      \@target: '/instrument/wavelength'
      dimensions:
        rank: 1
        dim: [[1, N_wavelength]]

    measured_data(NX_NUMBER):
      doc: "Resulting data from the measurement, described by data type.\n
        Minimum two columns containing Psi and delta, or for the normalized Mueller matrix,
        it may be 16 (or 15 if 1,1 is all 1)."
      #data(NX_NUMBER):
      dimensions:
        rank: 5
        dim: [[5, N_time], [4, N_p1], [3, N_angles], [2, N_variables], [1, N_wavelength]]

    uncertainty(NX_NUMBER):
      doc: "Specified uncertainties (errors) of the data described by data type. The structure is the same as for the measured data."
      exists: recommend
      dimensions:
        rank: 5
        dim: [[5, N_time], [4, N_p1], [3, N_angles], [2, N_variables], [1, N_wavelength]]

    stage(NXsubentry):
      doc: A link to the already existing information about sample position.
      link: '/instrument/stage'

    angle_of_incidence:
      doc: The incident angle of the beam vs. the normal of the sample surface.
      # I use @nx_link instead of the --> nexus syntax
      link: '/instrument/angle_of_incidence'

    time_points(NX_NUMBER): # can this also be shifted to varied parameters?
      doc: An array of relative time points if a time series was recorded
      unit: NX_TIME

    medium:
      # we need this or the next one
      exists: required
      doc: "Describe what was the medium above or around the sample. The common model is built up from substrate to the medium on the other side. Both boundaries are assumed infinite in the model. Here define the name of the material (e.g. water, air, etc.)."
        #"built up (from the upper atmosphere/substrate phase boundary to ..." ?

    medium_refractive_indices(NX_NUMBER):
      doc: Array of pairs of complex refractive indices of the medium for every measured wavelength.
      unit: NX_UNITLESS
      dimensions:
        rank: 2
        dim: [[1, N_wavelength], [2, 2]]

    environment_conditions:
      doc: External parameters that have influenced the sample.

    number_of_runs(NX_UINT):
      doc: "How many measurements were done varying the parameters? This forms an extra dimension beyond incident angle and energy / wavelength."

    varied_parameters:
      doc: "Indicates which parameter was changed. Its definition must exist below. The specified variable has to be number_of_runs long, providing the parameters for each data set."
      enumeration: [optical excitation, voltage, temperature, pH, stress, stage positions]

    length_of_runs(NX_UINT):
      doc: Provide the number of parameters used, N_p1
      unit: NX_DIMENSIONLESS
      #value: N_p1

    optical_excitation(NXsubentry):
      #is a boolean sufficient as a storage container?
      doc: "Was the sample modified using an optical source? Describe in this group
        the parameters of the optical excitation used."
      excitation_source:
        doc: Specify the source for the external excitation

      excitation_wavelength(NX_NUMBER):
        doc: "Wavelength value(s) or the range used for excitation.\n
        In cases of continuous laser radiation a value or a set of values may do but for other illumination types, such as pulsed lasers, or lamps, a range may describe the source better."
        unit: NX_LENGTH
      broadening(NX_NUMBER):
        doc: Specify the FWHM of the excitation
        unit: NX_LENGTH
      excitation_type:
        doc: CW or pulsed excitation
        enumeration: [cw, pulsed]
      pulse_length(NX_NUMBER):
        unit: NX_TIME
      repetition_rate(NX_NUMBER):
        unit: NX_FREQUENCY
      pulse_energy(NX_NUMBER):
        doc: The integrated energy of light pulse.
        unit: NX_ENERGY
      excitation_power(NX_NUMBER):
        unit: NX_ENERGY

    voltage(NX_NUMBER):
      doc: Specify the voltage if the spectra were taken under bias
      # ... continue to explain what is the user should do then
      unit: NX_VOLTAGE
    temperature(NX_NUMBER):
      doc: Temperature of the sample (sample holder, medium)
      unit: nx_temperature
      #alternative:
      #  \@nx_class: nx_char
      #  enumeration: [room temperature, RT]
    pH(NX_NUMBER):
      doc: pH of medium (measured or set)
      unit: NX_UNITLESS
      #alternative:
      #  \@nx_class: nx_char
      #  enumeration: [neutral, undefined]
    stress(NX_NUMBER):
      #  -- for this, we can take the original stress_field from NX_sample...
      doc: "Mechanical stress exerted on the sample."
      unit: NX_PRESSURE
    stress_orientation(NX_NUMBER):
      doc: "Euler angles of stress relative to sample in the stage coordinate system, see instrument/stage translation part, axes X,Y,Z."
      unit: NX_ANGLE
      dimensions:
        rank: 1
        dim: [[1, 3]]
      # UNCLEAR, which Euler angles, i.e. according to which convention how mapping to reference coordinate system, why not use stress or strain tensor applied on sample?
# derived parameters

  derived_parameters(NXcollection):
    # use NX_process?
    doc: What parameters are derived from the above data
    depolarization(NX_NUMBER):
      doc: light loss due to depolarization as a value in [0-1]
      unit: NX_UNITLESS
