# kuehbacm at hu-berlin.de, 01/2022
# a draft version of a NeXus application definition for storing atom probe microscopy (atom probe tomography and field-ion microscopy) experiments
# the draft is strongly inspired by the instrument use case of the so-called local electrode atom probe (LEAP) of CAMECA/Ametek but can also handle
# community-built instrument like the Oxcart instrument of the Felfer group
category: application
doc: "Draft application definition for atom probe tomography and related field-ion microscopy, all summarized as atom probe microscopy experiments."
symbols:
  doc: "The symbols used in the schema to specify e.g. dimensions of arrays"
  Nions: "Total number of ions collected"
(NXapm):
  (NXentry):
    # the NeXus default for application definitions wrt to the exists keyword is that it is required
    # so writing exists required can be omitted unless exists should be set to e.g. optional, recommended, or the [min, .., max, ..] syntax
    definition:
      doc: "Official NeXus NXDL schema to which this entry conforms."
      \@version:
        doc: "Version specifier which enables documentation of modifications to the schema."
    experiment_identifier:
      doc: "Ideally, a (globally persistent) unique identifier for referring to this experiment. The identifier is usually defined/issued by the facility, laboratory, or the principle investigator. The identifier enables to link experiments to e.g. proposals."
    experiment_description:
      exists: optional
      doc: "Possibility for leaving a free-text description about the experiment. Users are strongly advised to detail the sample history in the respective field and fill rather as completely as possible the fields of this application definition rather than writing these details in prose into this field."
    start_time(NX_DATE_TIME):
      doc: "ISO 8601 formatted time code with local time zone offset to UTC information included when the experiment started. If the application demands that time codes in this section of the application definition should only be used for specifying when the experiment was performed - and the exact duration is not relevant - this start time field should be used. Often though it is useful to specify a time interval with specifying both start_time and end_time to allow for more detailed bookkeeping and interpretation of the experiment. The user should be aware that even with having both time instances specified it may not be advisable to infer how long the experiment took or for how long data were acquired. More detailed timing data over the course of the experiment have to be collected."
    end_time(NX_DATE_TIME):
      exists: recommended
      doc: "ISO 8601-formatted time code with local time zone offset to UTC included when the experiment ended."
    # NEW ISSUE: fields like duration need a clearer description as to how these quantities should be defined. Most atom probers do not care for this other than getting an approximate hour-accurate estimate of the time how long it took to evaporate the specimen.
    program_name:
      doc: "Commercial or otherwise given name to the program that was used to acquire/measure the dataset. Atom probe microscopy experiments are nowadays still in most cases controlled via commercial software. These are often designed as integrated acquisition and instrument control software. For AMETEK/Cameca local electrode atom probe (LEAP) instruments the least processed (rawest) numerical results and metadata are stored in so-called RHIT and HITS files, which are proprietary. Supplementary metadata are kept in a database which is connected to the control software. RHIT and HITS are proprietary binary file formats whose content must not be accessed with software other than of AMETEK (IVAS/AP Suite). In effect, RHIT and HITS store the experiment in a closed manner that is practically useless for users unless they have access to the commercial software. To arrive at a state that atom probe microscopy delivers a dataset with which one can study reconstructed atomic position and do e.g. composition analyses or other post-processing analysis tasks, these raw data have to be processed. Therefore, it is necessary that for an application definition to be useful details about the physical acquisition of the raw data and all its processing steps have to be stored to arrive at derived quantities like ion hit positions (on the detector), calibrated time-of-flight data, and from these results obtain calibrated mass-to-charge-state ratios, and finally the tomographically reconstructed atomic positions. In many cases cases, an APM dataset is useful only if it gets post-processed via so-called ranging. Ranging defines a set of rules how to map between time-of-flight and mass-to-charge data on ion types with which in turn one can decode elemental identities and resolve isotopes. All these steps are in most cases performed using commercial software. Frequently, though, ranging and post-processing is also performed with (open-source) research software. Therefore, there is strictly speaking not a single program used in atom probe to arrive at a useful reconstructed and ranged dataset. Hence, the reason to design the application definition with the acquisition and key post-processing steps."
      \@version:
        doc: "Ideally program version plus build number, or commit hash or description of ever persistent resources where the source code of the program and build instructions can be found so that the program can be configured ideally in such a manner that the result file is numerically recreatable in the same deterministic manner."
    run_number(NX_CHAR):
      doc: "Not the specimen name or the experiment identifier but the identifier through which the experiment is referred to in the control software. For LEAP instruments it is recommended to use the IVAS/AP Suite run number. For other instruments, such as the one from Stuttgart or Oxcart from Erlangen, or the instruments in Rouen, use the identifier that is closest in meaning to the LEAP run number. As a destructive microscopy method, a run can be performed only once. It is possible, however, to interrupt a run and restart, still all using the same specimen. In this case, each evaporation run needs to be distinguished with different run numbers. # This is how most atom probe groups handle it across the globe."
    experiment_documentation(NXnote):
      exists: optional
      doc: "Binary container for a file or a compressed collection of files which can be used to add further descriptions and details to the experiment. The container can hold e.g. a ppt, pdf, latex, txt, image, or zip archive ...)."
    thumbnail(NXnote):
      exists: recommended
      doc: "A small image that is representative of the entry. For reconstructed datasets it is recommended to display the reconstruction as a 640x480 pixel jpeg image. Adding a scale bar to that image is recommended but not required as the main purpose of the thumbnail is to provide e.g. thumbnail images for displaying them in data repositories."
      \@type:
    operation_mode(NX_CHAR):
      doc: "What type of atom probe microscope experiment is performed. This field can be used e.g. by materials database systems to qualitatively filter experiments."
      enumeration: ["leap", "apt", "fim", "apt + fim"]
    operator(NXuser):
      exists: [min, 1]
      doc: "Contact information of at least the user of the instrument who measured this specimen or the principal investigator who performed this experiment. Adding multiple users if relevant is recommended."
      name:
        doc: "Given (first) name and surname of the user."
      affiliation:
        exists: recommended
        doc: "Name of the affiliation of the user at the point in time when the experiment was performed."
      address:
        exists: recommended
        doc: "Postal address of the affiliation."
      email:
        doc: "Email address of the user at the point in time when the experiment was performed. Given the most permanently used email is recommended."
      orcid:
        exists: recommended
        doc: "Globally unique identifier of the user as offers by services like ORCID or Researcher ID."
      telephone_number:
        exists: recommended
        doc: "(Business) (tele)phone number of the user at the point in time when the experiment was performed."
      role:
        exists: recommended
        doc: "Which role does the user have in the place, and at the point in time when, the experiment was performed (e.g. technician operating the microscope, student, postdoc, principal investigator, guest ...)."
      # NEW ISSUE: social media
    specimen(NXsample):
      name:
        doc: "Descriptive name or identifier with which to distinguish the specimen from all others and especially the parts from where it was cut. In cases where the specimen was e.g. site-specifically cut from samples or in cases of an instrument session during which multiple specimens are loaded, the name has to be descriptive enough to resolve which specimen on e.g. the microtip array was taken. The user is advised to store the details how specimens were cut/prepared from samples in the sample history."
      sample_history:
        doc: "Ideally, a reference to the location of or a (globally persistent) unique identifier of e.g. another file which should document ideally as many details as possible of the material, its microstructure, and its thermo-chemo-mechanical processing/preparation history. In the case that such a detailed history of the sample/specimen is not available, use this field as a free-text description to specify a sub-set of the entire sample history, i.e. what you would consider being the key steps and relevant information about the specimen, its material, microstructure, thermo-chemo-mechanical processing state and details of the preparation."
      preparation_date(NX_DATE_TIME):
        exists: recommended
        doc: "ISO8601 date and time with local time zone offset to UTC included when the specimen was prepared. Ideally report the end of the preparation, i.e. the last known time the measured specimen surface was actively prepared. Knowing when the specimen was exposed to e.g. specific atmosphere is especially required for environmentally sensitive material such as hydrogen-charged specimens or experiments including tracers with a short half-time. The user is advised to include these temporal details in the sample_history."
      short_title:
        exists: optional
        doc: "Possibility to give an abbreviation of the specimen name field."
      atom_types:
        doc: "Use Hill's system for listing elements of the periodic table which are inside or attached to the surface of the specimen and thus considered relevant from a scientific point. The purpose of the field is to offer materials database systems an opportunity to parse the relevant elements without having to interpret these from the sample history."
    (NXdata):
      doc: "Hard link to a location/locations in the hierarchy of the NeXus file where the data for default plotting are stored."
      # detector_stack(link):
      #  target: /entry/atom_probe/ion_impact_positions/hit_positions
        #handle default plotting
      # tomographic_reconstruction(link):
      #  target: /entry/atom_probe/reconstruction/reconstructed_positions
    atom_probe(NXinstrument):
      doc: "Metadata and numerical data of not only the microscope but also the lab in which this microscope is located. An atom probe microscope (experiment) is different compared to a large-scale facility accelerator or an electron microscope in at least two ways. First, ionized atoms and molecular ion(s fragments) (in the case of atom probe tomography) and (primarily) imaging gas ions (in the case of field ion microscopy) are accelerated towards a position-sensitive and time-of-flight taking detector system. Hence, there is no real probe/beam. Second, the specimen is the lens of an atom probe microscope. Therefore, the reference coordinate system that is usually referred to in NeXus (McStas coordinate system) is modified when using this application definition. Specifically, the reference coordinate system is defined such that it represents the specimen coordinate system. To be consistent with accelerator and microscopy techniques we define that the positive z-axis points outwards from the apex of the specimen into the vacuum, i.e. towards the detector. The coordinate system remains/is a right-handed one. Clockwise rotations are considered positive rotations."
      name:
        doc: "Given name of the microscope, e.g Raptor, Oxcart, One atom at a time."
      location:
        exists: recommended
        doc: "Geographic coordinates of the lab or the place where the instrument is installed using GEOREF geocodes ideally."
      instrument_manufacturer:
        doc: "Manufacturer of the entire instrument (e.g. AMETEK/Cameca) to enable e.g. queries in materials database systems for instrument manufacturers. Usually more technical details are needed though to specify the instrument, these should be written into instrument_model and instrument_capabilities."
      instrument_model:
        doc: "Manufacturer brand/model to enable e.g. queries about microscope models (e.g. LEAP3000XS)."
      instrument_identifier:
        exists: recommended
        doc: "Hardware name/serial number or hash identifier given by the manufacturer to identify the instrument."
      instrument_capability:
        exists: recommended
        doc: "Free-text list possibly multiple terms of functionalities which the instrument provides."
        # NEW ISSUE: Define a bag of controlled words and use only these.
      flight_path_length(NX_FLOAT):
        doc: "The space inside the atom probe that ions pass through when they leave the specimen and travel to the detector."
        unit: NX_LENGTH
        # NEW ISSUE: discussion depends on the type of instrument, straight flight path, curved
      counter_electrode(NXlens_apm):
        has_reflectron(NX_BOOLEAN):
        name:
          exists: recommended
        model:
          exists: recommended
        serial_number:
          exists: recommended
        manufacturer_name:
          exists: recommended
        (NXtransformations):
          exists: optional
        flat_test_data(NXcollection):
        # NEW ISSUE: the definition of flat test data should be included and documented
        (NXaperture):
          description:
            exists: recommended
            doc: An (ideally globally persistent) unique identifier, link, or text which gives further details.
      ion_detector(NXdetector):
        doc: "Details about the detector which is used to collect raw time-of-flight data and ion/hit impact positions."
        type:
          exists: recommended
          doc: "Description of the detector type. Specify if the detector is not the usual type of delay-line detectors."
          enumeration: ["mcp dld", "phosphor ccd"]
        name:
          exists: recommended
          doc: "Given name."
        model:
          exists: recommended
          doc: "Given brand or model name by the manufacturer."
        serial_number:
          exists: recommended
          doc: "Given hardware name/serial number or hash identifier issued by the manufacturer."
        manufacturer_name:
          exists: recommended
          doc: "Given name of the manufacturer."
        (NXtransformations):
          exists: [min, 0]
          doc: "Affine transformation which aligns the Cartesian right-handed coordinate system which defines the detector space with the specimen space. In atom probe microscopy a frequently used choice is to discuss the so-called detector space image (stack). This is a stack of two-dimensional histograms of detected ions within a predefined evaporation ID interval. Typically, the set of ion evaporation sequence IDs is grouped into chunks. For each chunk a histogram of the ion hit positions on the detector is computed. This leaves the possibility for inconsistency between the so-called detector coordinate system and a specimen-affixed coordinate system. The transformation here resolves this ambiguity by specifying how the positive z-axes of either coordinate systems can be oriented."
        signal_amplitude(NX_FLOAT):
          exists: optional
          doc: "Amplitude of the signal detected on the multi-channel plate (MCP). This field should be used for storing the signal amplitude quantity of within historic the ATO-formatted files. The ATO file format is used primarily by the atom probe groups in Rouen, France."
          unit: NX_CURRENT
          dimensions:
            rank: 1
            dim: [[1, Nions]]
      laser_or_high_voltage_pulser(NXpulser_apm):
        pulse_mode:
          enumeration: ["laser", "high voltage"]
        laser_pulser(NXsource):
          exists: optional
          name:
            exists: recommended
            doc: "Given name."
          model:
            exists: recommended
          serial_number:
            exists: recommended
          manufacturer_name:
            exists: recommended
          wavelength(NX_FLOAT):
            unit: NX_WAVELENGTH
          pulse_energy(NX_FLOAT):
            unit: NX_ENERGY
          power(NX_FLOAT):
            exists: recommended
            unit: NX_POWER
          (NXtransformations):
            exists: recommended
        laser_beam(NXbeam):
          exists: optional
          pinhole_position(NXcollection):
            exists: recommended
          spot_position(NXcollection):
            exists: recommended
        pulse_frequency(NX_NUMBER):
          unit: NX_FREQUENCY
        pulse_fraction(NX_NUMBER):
          unit: NX_UNITLESS
        pulsed_voltage(NX_FLOAT):
          exists: recommended
          unit: NX_VOLTAGE
          dimensions:
            rank: 1
            dim: [[1, Nions]]
        standing_voltage(NX_FLOAT):
          exists: recommended
          unit: NX_VOLTAGE
          dimensions:
            rank: 1
            dim: [[1, Nions]]
      (NXstage_lab):
        # NEW ISSUE: consider more detailed opportunities for specifying holders like cryo-controller holder, type of holder, material for pucks make a difference for studies which hunt for hydrogen signal, equally dwell time in buffer and load lock chamber and environmental transfer, the application definition does not account for this at the moment, would need a class representing stage and specimen holder hierarchy of the entire sample loading and transfer system and the contributions or not these components make wrt to contamination.
        design:
          exists: recommended
        name:
          exists: recommended
        model:
          exists: recommended
        serial_number:
          exists: recommended
        manufacturer_name:
          exists: recommended
        description:
          exists: optional
        (NXtransformations):
          exists: optional
        (NXpositioner):
          exists: optional
        base_temperature(NX_FLOAT):
          doc: "Average temperature at the specimen base, i.e. base temperature, during the measurement."
          unit: NX_TEMPERATURE
        # NEW ISSUE: base_temperature_time_profile(NXtime_data):
        # eventually replace NXtime_data with NXlog
        #  exists: recommended
        #  doc: "Base temperature (time) profile during the measurement. Use base_temperature if a nominal/average value suffices."
        #  will the symbols from NXtime_data be carried over, goes along the line of tommaso's comment:
        #  In order to extend existing base classes, would it make sense to add a function to yam2nxdl that, if a base class already exists, 
        #  the tool only appends the new fields? I think the issue of significant extensions of existing base classes will
        #  symbols:
        #    doc: The symbols used in the schema to specify e.g. dimensions of arrays.
        #    Nsnapshots: Number of values sampled
        #  event_time_zero(NX_DATE_TIME):
        #    exists: required
        #    doc: ISO8601 when time monitoring started.
        #  time(NX_NUMBER):
        #    exists: required
        #    doc: Offset to event_time_zero when a snapshot is taken.
        #    unit: NX_TIME
        #    dimensions:
        #      rank: 2
        #      dim: [[1, Nsnapshots]]
        #  base_temperature(NX_FLOAT):
        #    exists: required #means if an NXtime_data group is added it needs to be populated not only with time but also base_temperature data
        #    unit: NX_TEMPERATURE
        #    dimensions:
        #      rank: 1
        #      dim: [[2, Nsnapshots]]
      control_software(NXcollection):
        doc: "The majority of atom probe microscopes come from a single commercial manufacturer AMETEK (formerly Cameca). Their instruments are controlled via an(/a set) of integrated instrument control system(s) (APSuite/IVAS/DAVis). By contrast, instruments which were built by individual research groups such as of the French (GPM, Rouen, France), the Schmitz (Inspico, Stuttgart, Germany), the Felfer (Oxcart, Erlangen, Germany), or the PNNL group (Pacific Northwest National Laborary, Portland, Oregon, U.S.) have individual solutions to control the instrument. Some of which are modularized and open, some of which realize also integrated control units with portions of eventually undisclosed source code and (so far) lacking (support of)/open APIs. Currently, the is no community-specific API for getting finely granularized access to such control settings. This motivates the current design of the application definition via an NXcollection. Holding heterogeneous, not yet standardized but relevant pieces of information is the purpose of this collection."
        # NEW ISSUE: With new development pull fields out of this collection into dedicated groups.
        analysis_chamber(NXcollection):
          # symbols:
          #   Ntlogs: Number of time logs
          doc: "Track time-dependent settings over the course of the measurement about the environment in the analysis chamber such as gas pressure values etc."
          pressure(NX_FLOAT):
            doc: "Average pressure in the analysis chamber."
            unit: NX_PRESSURE
          # follow the example of base_temperature_time_profile
          # pressure_time_profile(NX_FLOAT):
          #  exists: recommended
          #  dimensions:
          #    rank: 2
          #    dim: [[2, Ntlogs]]
          #  unit: NX_ANY
        # buffer_chamber(NXcollection):
        #   doc: "Track time-dependent settings over the course of the measurement and loading about the environment in the buffer chamber such as gas pressure values etc."
        # load_lock_chamber(NXcollection):
        #   doc: Track time-dependent settings over the course of the measurement and loading about the environment in the load-lock chamber such as gas pressure values etc.
        # NEW ISSUE: activate eventually relevant fields in the buffer and load_lock chambers
      specimen_monitoring(NXcollection):
        exists: optional
        # NEW ISSUE: should be promoted to recommended at some point in particular with closer integration of APM and EM instruments
        doc: "A place where details about the initial shape of the specimen can be stored. Ideally, here also data about the shape evolution of the specimen can be stored. There are currently few techniques to measure the shape evolution: One is via correlative electron microscopy but this usually evolves an interrupted experiment in which the specimen is transferred, an image taken, and a new evaporation sequence initiated. Another, less accurate method, though, is to monitor the specimen evolution via the in-built camera system (if available) in the instrument. Another method is to use correlated scanning force microscopy methods (pioneered by the imec group, Belgium). A continuous monitoring of the specimen in an correlative electron microscopy/atom probe experiment is planned to be developed by the JÃ¼lich group."
        # NEW ISSUE: consider the above comments into new fields when important progress has been made.
        initial_radius(NX_FLOAT):
          doc: "Ideally measured or best elaborated guess of the initial radius of the specimen."
          unit: NX_LENGTH
        shank_angle(NX_FLOAT):
          doc: Ideally measured or best elaborated guess of the shank angle. This is a measure of the specimen taper. Define it in such a way that the base of the specimen is modelled as a conical frustrum so that the shank angle is the (shortest) angle between the specimen space z-axis and a vector on the lateral surface of the cone.
          unit: NX_ANGLE
        # NEW ISSUE: define e.g. radius(NX_FLOAT) and evaporation_id(NX_UINT) to store snapshots of the shape evolution of the specimen.
      ion_impact_positions(NXprocess):
        exists: optional  # at the moment only for groups which built their own instrument these fields can realistically be populated
        # NEW ISSUE: promote to recommended with further permeation of open hardware protocols
        doc: "This group in the hierarchy should be used to store the ion hit positions. Data post-processing step of analog-to-digital conversion of the detector signals into ion hit positions. For AMETEK LEAP instruments this processing takes place partly in the control unit of the detector and is instructed and monitored/supervised by the acquisition/instrument control software (IVAS/APSuite/DAVis). The exact details are, at least in the case of AMETEK instruments (the large majority of installations worldwide) kept proprietary and inaccessible. For instruments like Oxcart individual timing data from the delay-line detector are open and thus community software can be used to decode these data into ion impact positions."
        symbols:
          doc: "Symbols used in the schema to specify e.g. dimensions of arrays."
          Ndldwires: "Total number of independent wires in the delay-line detector."
        program:
          doc: "Given name of the program that was used to perform this computation. Although, for LEAP from AMETEK this is often the same software as one would specify under program_name for the NXentry (usually IVAS or AP Suite), the field is required because in cases where data are post-processed with different software inconsistencies can occur."
          \@version:
            doc: "Ideally program version plus build number, or commit hash or description of ever persistent resources where the source code of the program and build instructions can be found so that the program can be configured ideally in such a manner that the result of this computational process is recreatable in the same deterministic manner."
        arrival_time_pairs(NX_NUMBER):
          exists: recommended
          doc: "Three-dimensional array of raw readings from the analog-to-digital-converter timing circuits of the detector wires."
          # NEW ISSUE: discuss with Oxcart developers which modifications might be necessary here.
          unit: NX_TIME
          dimensions:
            rank: 3
            dim: [[1, 2], [2, Ndldwires], [3, Nions]]
        hit_positions(NX_FLOAT):
          doc: "Evaluated ion impact coordinates at the detector (either as computed from the arrival time pairs or as reported as the result of a not further specified processing from commercial control software)."
          unit: NX_LENGTH
          dimensions:
            rank: 2
            dim: [[1, 2], [2, Nions]]
        detection_rate(NX_FLOAT):
          doc: Average detection rate over the course of the experiment.
          unit: NX_DIMENSIONLESS
          # NEW ISSUE: follow the example of base_temperature_time_profile to monitor the temporal evolution of the detection_rate over the course of the evaporation sequence
          # detection_rate_time_profile(NX_FLOAT):
          #   doc: Spatio-temporal profile of the detection rate since the start of the measurement.
          # NEW ISSUE: discuss how to handle cases when we would like to store ideally an array where one dimensions is NX_TIME and the other one is e.g. NX_PERCENT 
      hit_multiplicity(NXprocess):
        # NEW ISSUE: use symbols to monitor number of pulses
        exists: recommended
        doc: "Data post-processing step which is, like the impact position analyses also usually executed in the integrated control software. This processing yields how many ions where detected during the pulse as it is possible that multiple ions evaporate and hit the same detector pixel, which forms the foundation to analyses of the so-called multiplicity of the ion. Multiplicity must not be confused with how many atoms of the same element or isotope, respectively, built a molecular ion."
        program:
          doc: "Given name of the program that was used to perform this computation. Similar comments as to ion_impact_positions apply."
          \@version:
            doc: "Ideally program version plus build number, or commit hash or description of ever persistent resources where the source code of the program and build instructions can be found so that the program can be configured ideally in such a manner that the result of this computational process is recreatable in the same deterministic manner."
        pulses_since_last_ion(NX_UINT):
          exists: optional
          doc: "Number of pulses since the last detected ion pulse. For multi-hit records, after the first record, this is zero."
          dimensions:
            rank: 1
            dim: [[1, Nions]]
          unit: NX_UNITLESS
        hit_multiplicity(NX_UINT):
          exists: recommended
          doc: "Hit multiplicity."
          dimensions:
            rank: 1
            dim: [[1, Nions]]
          unit: NX_UNITLESS
        pulse_id(NX_UINT):
          exists: optional
          doc: "Number of pulses since the start of the atom probe run/evaporation sequence."
          dimensions:
            rank: 1
            dim: [[1, Nions]]
          unit: NX_UNITLESS
      ion_filtering(NXprocess):
        exists: recommended
        doc: "Like impact position and hit multiplicity computation ion filtering and are data post-processing steps for identifying which of the detected ions should be included in the voltage-and-bowl correction."
        program:
          doc: "Given name of the program that was used to perform this computation. Similar comments as to hit_multiplicity apply."
          \@version:
            doc: "Ideally program version plus build number, or commit hash or description of ever persistent resources where the source code of the program and build instructions can be found so that the program can be configured ideally in such a manner that the result of this computational process is recreatable in the same deterministic manner."
        evaporation_id_included(NX_BOOLEAN):
          doc: "Bitmask which is set to true if the ion is considered and false otherwise."
          dimensions:
            rank: 1
            dim: [[1, Nions]]
      voltage_and_bowl_correction(NXprocess):
        exists: recommended
        doc: "Data post-processing step to correct for ion impact position flight path differences, detector biases, and nonlinearities. Also this step is usually performed with commercial software."
        program:
          doc: "Given name of the program that was used to perform this computation. Similar comments as to ion_filtering apply."
          \@version:
            doc: "Ideally program version plus build number, or commit hash or description of ever persistent resources where the source code of the program and build instructions can be found so that the program can be configured ideally in such a manner that the result of this computational process is recreatable in the same deterministic manner."
        # NEW ISSUE: realistic is that currently scientists can pull always a calibrated time-of-flight but not necessarily unprocessed timing data from the detector (unless individuals built the instrument). Relevant for ranging are the calibrated data, thats why only these (as an intermediate/compromise solution) are required in this version of the application definition
        raw_tof(NX_FLOAT):
          exists: recommended
          doc: "Raw time-of-flight data as read-out from the acquisition software if these are available."
          unit: NX_TIME
          dimensions:
            rank: 1
            dim: [[1, Nions]]
        calibrated_tof(NX_FLOAT):
          doc: "Calibrated time-of-flight."
          unit: NX_TIME
          dimensions:
            rank: 1
            dim: [[1, Nions]]
        tof_calibration(NXcollection):
          exists: optional
          doc: "The key idea and algorithm of the voltage-and-bowl correction is qualitatively similar for instruments of different manufacturers or research groups but different specific calibration models exists. In the first draft of the application definition we do not wish to resolve or generalize these differences. Rather the purpose of this collection is to provide a container where model specific parameters and calibration models can be stored if users know these for sure. For AMETEK LEAP systems this should be the place for storing initial calibration values. These values are accessible normally only by AMETEK service engineers and used by them for calibrating for the detector and instrument. Furthermore, one could then also store here the iteratively identified calibrations which scientists will get displayed in e.g. AP Suite while executing the voltage-and-bowl correction as part of the reconstruction pipeline."
          # NEW ISSUE: should be recommended as otherwise one cannot ensure that numerically the same voltage-and-bowl correction results are obtained (without knowning the parameters...)
      mass_to_charge_conversion(NXprocess):
        exists: recommended
        doc: "Data post-processing step in which calibrated time-of-flight data (tof) are interpreted into mass-to-charge state ratios."
        program:
          doc: "Given name of the program that was used to perform this computation. Similar comments as voltage_and_bowl_correction apply."
          \@version:
            doc: "Ideally program version plus build number, or commit hash or description of ever persistent resources where the source code of the program and build instructions can be found so that the program can be configured ideally in such a manner that the result of this computational process is recreatable in the same deterministic manner."
        parameter(NXcollection):
          exists: recommended
          doc: "Like for the voltage-and-bowl correction this collection should be used for storing vendor-specific calibration models if available."
        mass_to_charge(NX_FLOAT):
          doc: "Mass-to-charge-state ratios"
          unit: NX_ANY
          # NEW ISSUE: add unit model according to Tommaso and Laurenz, default unit should be Dalton
          dimensions:
            rank: 1
            dim: [[1, Nions]]
      reconstruction(NXprocess):
        exists: recommended
        doc: "Data post-processing step to create a tomographic reconstruction of the specimen based on selected calibrated ion hit positions, the evaporation sequence, and voltage curve data. Very often scientists use own software scripts according to published, so-called reconstruction protocols, i.e. numerical recipes how to compute x, y, z atomic positions."
        program:
          doc: "Given name of the program that was used to perform this computation. Similar comments as voltage_and_bowl_correction apply."
          \@version:
            doc: "Ideally program version plus build number, or commit hash or description of ever persistent resources where the source code of the program and build instructions can be found so that the program can be configured ideally in such a manner that the result of this computational process is recreatable in the same deterministic manner."
        protocol_name:
          exists: recommended
          doc: "Qualitative statement about which algorithmic approach, i.e. reconstruction protocol was used."
          enumeration: ["bas original", "bas modified", "geiser", "gault", "ivas", "apsuite", "other"]
        reconstructed_positions(NX_FLOAT):
          doc: "Three-dimensional reconstructed positions of the ions. Interleaved array of x, y, z positions in the specimen space."
          unit: NX_LENGTH
          dimensions:
            rank: 2
            dim: [[1, 3], [2, Nions]]
        reconstruction_parameter(NXcollection):
          exists: recommended  # NEW ISSUE: the status here should be promoted to required but currently one needs to manually extract the reconstruction parameters for instance from commercial software, here a better strategy is needed how to document them.
          doc: "Different models and associated algorithms, i.e. (numerical) protocols exist to reconstruct atom probe data. Although these approaches are qualitatively similar, each protocol uses different parameters (and interprets these differently). The source code to IVAS/APSuite is not open. For now we store the reconstruction parameter in a collection."
          # NEW ISSUE: for AMETEK, as well as for the Bas, Geiser, and Gault protocols we know the usual naming of the parameters they should be added as optional quantities.
          # Therefore, it is difficult for now to generalize the meaning and idea behind all relevant reconstruction parameters. One could create a class for each reconstruction method, as these methods are de facto application definitions.
      ranging(NXprocess):
        exists: recommended
        doc: "Data post-processing step in which elemental, isotopic, and/or molecular identities are assigned to the ions. The documentation of these steps is based on ideas described in the literature (M. K\"uhbach et al. 2021, Microsc. Microanal.)."
        program:
          doc: "Given name of the program that was used to perform this computation. Apart from the classical approach to use AMETEK software for this processing step there have been a number of open-source tools been designed for this task. Therefore, it is essential to document which tool was used."
          \@version:
            doc: "Ideally program version plus build number, or commit hash or description of ever persistent resources where the source code of the program and build instructions can be found so that the program can be configured ideally in such a manner that the result of this computational process is recreatable in the same deterministic manner."
        number_of_iontypes(NX_UINT):
          doc: How many ion types are distinguished
          unit: NX_UNITLESS
        maximum_number_of_atoms_per_molecular_ion(NX_UINT):
          doc: "Assumed maximum value that suffices to store all relevant molecular ions even the most complicated ones. Usually a value of 32 suffices well."
          unit: NX_UNITLESS
        mass_to_charge_distribution(NXprocess):
          exists: recommended
          doc: "Specifies the computation of the mass-to-charge histogram. Usually mass-to-charge values are studied as an ensemble quantity and binned so document here settings related to (eventual) binning."
          program:
            doc: "Given name of the program that was used to perform this binning. If the computation is a integrated into the ranging tool, type ."
            \@version:
              doc: "Ideally program version plus build number, or commit hash or description of ever persistent resources where the source code of the program and build instructions can be found so that the program can be configured ideally in such a manner that the result of this computational process is recreatable in the same deterministic manner. If the version is the same as for the ranging tool, type ."
          range_minmax(NX_FLOAT):
            doc: "Smallest and largest mass-to-charge value."
            unit: NX_ANY
            # NEW ISSUE: NX_ATOMIC_MASS_UNIT use Tommasso scheme here Da
            dimensions:
              rank: 1
              dim: [[1, 2]]
          range_increment(NX_FLOAT):
            doc: "Binning width"
            unit: NX_ANY
            # NEW ISSUE: unit must match with range, is Da
        background_quantification(NXprocess):
          exists: recommended
          doc: "Details of the background model which was used to correct the total counts per bin into used counts."
          program:
            doc: "Given name of the program that was used to perform the background quantification. If the computation is a integrated into the ranging tool, type ."
            \@version:
              doc: "Ideally program version plus build number, or commit hash or description of ever persistent resources where the source code of the program and build instructions can be found so that the program can be configured ideally in such a manner that the result of this computational process is recreatable in the same deterministic manner. If the version is the same as for the ranging tool, type ."
          # NEW ISSUE: add parameters of the background model in an e.g. NXcollection as these are specific to every background model
        peak_search_and_deconvolution(NXprocess):
          exists: recommended
          doc: "How where peaks in the background-corrected mass-to-charge histogram identified."
          # NEW ISSUE: touching upon i.e. research activities by Andrew London and coworkers substantiating the need for a clearer description how peak/signals were eventually processed via deconvolution methods
          program:
            doc: "Given name of the program that was used to search and detect peaks. If the computation is a integrated into the ranging tool type ."
            \@version:
              doc: "Ideally program version plus build number, or commit hash or description of ever persistent resources where the source code of the program and build instructions can be found so that the program can be configured ideally in such a manner that the result of this computational process is recreatable in the same deterministic manner. If the version is the same as for the ranging tool, type ."
          (NXpeak):
            exists: optional
            doc: "List of peaks."
            symbols:
              doc: "The symbols used in the schema to specify e.g. dimensions of arrays."
              Nsupport: "Number of support points"
            label:
            peak_model:
              enumeration: ["empirical", "gaussian", "lorentzian"]
            position(NX_NUMBER):
              unit: NX_ANY
              dimensions:
                rank: 1
                dim: [[1, Nsupport]]
            intensity(NX_NUMBER):
              unit: NX_ANY
              dimensions:
                rank: 1
                dim: [[1, Nsupport]]
            (NXcollection):
              exists: optional
              doc: "Placeholder for additional details and mathematical models used."
        peak_identification(NXprocess):
          exists: recommended
          doc: "Details about how peaks, with taking into account error models, were interpreted as an iontype or not."
          program:
            doc: "Given name of the program that was used to perform identify peaks. If the computation is a integrated into the ranging tool, type ."
            \@version:
              doc: "Ideally program version plus build number, or commit hash or description of ever persistent resources where the source code of the program and build instructions can be found so that the program can be configured ideally in such a manner that the result of this computational process is recreatable in the same deterministic manner. If the version is the same as for the ranging tool, type ."
          (NXion):
            exists: optional
            doc: "The individual ions and their set of mass-to-charge intervals (ranges). If ranging was performed as a computational step then the NeXus-writing software needs to assure that there is always a default ion type which is the unknown ion type. By definition this unknown type has 0 as the id and a default associated mass-to-charge-state ratio interval of [0, 0.001] Da."
            symbols:
              doc: "The symbols used in the schema to specify e.g. dimensions of arrays."
              Nivecmax: "Maximum number of allowed atoms per (molecular) ion (fragment). Needs to match maximum_number_of_atoms_per_molecular_ion."
              Nranges: "Number of mass-to-charge-state-ratio range intervals mapped on this ion type."
            ion_type(NX_UINT):
              unit: NX_UNITLESS
            isotope_vector(NX_UINT):
              unit: NX_UNITLESS
              dimensions:
                rank: 1
                dim: [[1, Nivecmax]]
            charge_state(NX_INT):
              exists: recommended
              unit: NX_DIMENSIONLESS
            name(NX_CHAR):
              exists: optional
            mass_to_charge_range(NX_FLOAT):
              unit: NX_ANY
              dimensions:
                rank: 2
                dim: [[1, 2], [2, Nranges]]
      # NEW ISSUE: design for each processing step a customized NXapm_process_<name> base class
      # for clustering it could include the following entries:
      # clustering(NXprocess):
      #   exists: optional
      #   doc: to be defined 
      #   evaporation_id_included(NX_BOOLEAN):
      #     doc: Bitmask if ion is to be considered or not
      #     dimensions:
      #       rank: 1
      #       dim: [[1, Nions]]
      #   feature_id(NX_UINT):
      #     exists: recommended
      #     doc: In case of running a clustering analysis on the entire dataset we might add a label which specifies to which microstructural feature (e.g.) the ion belongs. The value zero is reserved to flag that an ion does not belong to a feature. Therefore, feature identifiers start at 1. #later we could add at some value.
      #     unit: NX_UNITLESS
      #     dimensions:
      #       rank: 1
      #       dim: [[1, Nions]]
